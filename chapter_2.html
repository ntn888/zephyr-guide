<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The Kernel API - Threads</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="title-page.html">The Zephyr Guide</a></li><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="chapter_2.html" class="active"><strong aria-hidden="true">2.</strong> The Kernel API - Threads</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Basic Peripherals API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_3-01.html"><strong aria-hidden="true">3.1.</strong> Device Tree 101</a></li><li class="chapter-item expanded "><a href="chapter_3-02.html"><strong aria-hidden="true">3.2.</strong> GPIO</a></li><li class="chapter-item expanded "><a href="chapter_3-03.html"><strong aria-hidden="true">3.3.</strong> Interrupts</a></li><li class="chapter-item expanded "><a href="chapter_3-04.html"><strong aria-hidden="true">3.4.</strong> Timers</a></li><li class="chapter-item expanded "><a href="chapter_3-05.html"><strong aria-hidden="true">3.5.</strong> PWM</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_4.html"><strong aria-hidden="true">4.</strong> Kernel Facilities - Messaging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_4-01.html"><strong aria-hidden="true">4.1.</strong> Semaphores</a></li><li class="chapter-item expanded "><a href="chapter_4-02.html"><strong aria-hidden="true">4.2.</strong> Mutex</a></li><li class="chapter-item expanded "><a href="chapter_4-03.html"><strong aria-hidden="true">4.3.</strong> Message Queues</a></li></ol></li><li class="chapter-item expanded "><a href="chapter_5.html"><strong aria-hidden="true">5.</strong> Device Driver Intro</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-kernel-api---threads"><a class="header" href="#the-kernel-api---threads">The Kernel API - Threads</a></h1>
<p>We will now look at the minimum Kernel API required to get going with the Peripherals. We will now look at the Threads API in this section. First the concepts.</p>
<h2 id="real-time-system"><a class="header" href="#real-time-system">Real-Time System</a></h2>
<p>Real-time systems are characterized by the severe consequences that result if logical as well as timing correctness properties of the system are not met. Two types of real-time systems exist: soft and hard. In a soft real-time system, tasks are performed by the system as fast as possible, but the tasks donâ€™t have to finish by specific times. In hard real-time systems, tasks have to be performed not only correctly but on time. Most real-time systems have a combination of soft and hard requirements. Real-time applications cover a wide range, but most real-time systems are embedded.</p>
<p>Real-time software applications are typically more difficult to design than non-real-time applications. This chapter describes real-time concepts.</p>
<h2 id="rtos"><a class="header" href="#rtos">RTOS</a></h2>
<p>What is an RTOS?</p>
<p>RTOSes include a component called the <em>kernel</em>. The kernel is responsible for task management in a multitasking system.</p>
<p>Multitasking can be achieved without an RTOS. This can be done in a <em>super-loop</em>. Small systems of low complexity are designed this way. It is upto the application to manage the scheduling between tasks. But this is error-prone and most notably, if a code change is made, the timing of the loop is affected.</p>
<p>The RTOS abstracts this away for us. And brings in the concept called <em>threads</em>. A firmware designer splits the related work responsible for a portion of the solution to be done into individual threads. The kernel performs the <em>context switching</em>, ie: save the current thread context (CPU registers) in the current task storage area then resume execution of new code<sup class="footnote-reference"><a href="#1">1</a></sup>. Each thread is assigned a <em>priority</em>. Each thread is an infinite loop that can be in any one of the 6 states; see the diagram below.</p>
<p>A task is ready when it can execute but its priority is less than the currently running task. A task is running when it has control of the CPU. A task is waiting when it requires the occurrence of an event (for example, waiting for an I/O operation to complete, a shared resource to be available, a timing pulse to occur, or time to expire). Finally a task is in suspended state when it is explicitly requested by the code (either within itself or another thread).</p>
<p><img src="./images/thread_states.svg" alt="the 6 thread states" /></p>
<p>You may want to ask, when should I use an RTOS?</p>
<p>- The answer is ALWAYS.
These days the embedded system landscape has changed that such is the case. For example the bluepill<sup class="footnote-reference"><a href="#2">2</a></sup> with 128k flash and 20K RAM can be had for a fraction of a dollar.</p>
<p>In addition to the kernel, an RTOS can include device drivers and peripheral management as in the case of Zephyr.
Now that we have an understanding of the kernel and threads, let's see the implementation in Zephyr.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>This adds overhead, the biggest downsides of using RTOS.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>https://docs.zephyrproject.org/2.6.0/boards/arm/stm32_min_dev/doc/index.html</p>
</div>
<h2 id="thread-creation"><a class="header" href="#thread-creation">Thread Creation</a></h2>
<pre><code>define MY_STACK_SIZE 500
define MY_PRIORITY 5

extern void my_entry_point(void *, void *, void *);

K_THREAD_STACK_DEFINE(my_stack_area, MY_STACK_SIZE);
struct k_thread my_thread_data;

k_tid_t my_tid = k_thread_create(&amp;my_thread_data, my_stack_area,
                                 K_THREAD_STACK_SIZEOF(my_stack_area),
                                 my_entry_point,
                                 NULL, NULL, NULL,
                                 MY_PRIORITY, 0, K_NO_WAIT);
</code></pre>
<p>The preceding code spawns a thread immediately. We will study the arguments of the above function one at a time.</p>
<p><code>&amp;my_thread_data</code>: this is of type struct <code>k_thread</code> defined in <code>thread.h</code>. see definition in <a href="https://docs.zephyrproject.org/latest/reference/kernel/threads/index.html#structk__thread">docs</a>.</p>
<p><code>my_stack_area</code>: Pointer to the stack space. </p>
<p>The above C structs must be initialised using the above shown functions before using in the creation function! See <a href="https://docs.zephyrproject.org/latest/reference/kernel/threads/index.html#c.k_thread_create">here</a> for more info.</p>
<p><code>my_entry_point</code>: the entry point function (user defined), that takes upto 3 arguments. It's passed 'NULL' in this example.</p>
<p><code>MY_PRIORITY</code>: the priority assigned for this thread. We will discuss priorities in detail below.</p>
<p><code>timeout</code>: the amount of time in milliseconds to wait before the kernel actually starts the thread. Here it's <code>K_NO_WAIT</code>; ie 0.</p>
<h2 id="thread-priorities"><a class="header" href="#thread-priorities">Thread Priorities</a></h2>
<p>There are two classes of threads:</p>
<ul>
<li>cooperative thread (cannot be pre-empted): negative priority. Ideally used for device drivers and critical work.</li>
<li>preemptible thread: positive priotity</li>
</ul>
<p>Note that thread priorities can be changed later in the program. The kernel natively supports unlimited priority levels. But in a real application, it's as follows:</p>
<p><img src="./images/priorities.svg" alt="priorities" /></p>
<p>As can be seen, <code>CONFIG_NUM_COOP_PRIORITIES</code> and <code>CONFIG_NUM_PREEMPT_PRIORITIES</code> specify the limits of usable priority values for the specific application.</p>
<h3 id="notable-thread-option"><a class="header" href="#notable-thread-option">Notable thread option</a></h3>
<ul>
<li>K_ESSENTIAL: if the thread terminates, treat as system failure! default: not enabled.</li>
</ul>
<h2 id="thread-termination"><a class="header" href="#thread-termination">Thread termination</a></h2>
<p>Once a thread is started it runs forever. A thread may terminate by returning to the caller. ie 'return x'. The thread must be responsible for releasing any held resourses.
To wait until another thread terminates use <code>k_thread_join()</code>.
<code>k_thread_abort()</code> (ungracefully)  terminates the thread. Can be also used from within an external thread. It's not recommended to use this function as it leads to unfreed resources.</p>
<h2 id="notable-system-threads"><a class="header" href="#notable-system-threads">Notable system threads</a></h2>
<p>These are <em>essential threads</em> that are always present in an application.</p>
<h3 id="main-thread"><a class="header" href="#main-thread">main thread</a></h3>
<p>By default has a priority of 0 (highest pre-emptive). Performs kernel initialisation and runs the <code>main()</code> function.</p>
<h3 id="idle-thread"><a class="header" href="#idle-thread">idle thread</a></h3>
<p>Executes when no work. Puts the processor to auto- powersave. Always has the lowest priority.</p>
<h2 id="delays"><a class="header" href="#delays">Delays</a></h2>
<p>Use <code>k_sleep()</code> to do a delay within a thread. <code>k_msleep()</code> is a more useful version where you supply the delay in milliseconds. An inactive thread that's in this state can be woken up from another thread prematurely by <code>k_wakeup()</code>. If the delay is too short to warrant pre-emption use the blocking function <code>k_busy_wait()</code>.</p>
<h2 id="simple-thread-example"><a class="header" href="#simple-thread-example">Simple thread example</a></h2>
<p>We will see an example built on the above concepts and study it...</p>
<pre><code>#include &lt;zephyr.h&gt;
#include &lt;sys/printk.h&gt;

#define MY_STACK_SIZE 1024
#define MY_PRIORITY 7

void* thread1(void) {
	while(1) {
		printk(&quot;thread1\n&quot;);
		k_msleep(2000);		// sleep 2s
	}
	return NULL;
}

void* thread2(void) {
	while(1) {
		printk(&quot;thread2\n&quot;);
		k_msleep(2000);		// sleep 2s
	}
	return NULL;
}

K_THREAD_DEFINE(thread1_id, MY_STACK_SIZE, thread1, NULL, NULL, NULL,
		MY_PRIORITY, 0, 0);
K_THREAD_DEFINE(thread2_id, MY_STACK_SIZE, thread2, NULL, NULL, NULL,
		MY_PRIORITY, 0, 0);

</code></pre>
<p>The first line includes the 'zephyr.h' file which in turn includes the kernel. Which enables the kernel subsystem which is the subject of our topic here. The second line imports the print subsytem which we use here to print though the UART.</p>
<p>We are writing two individual thread functions (to keep things simple) that'll be invoked next. Here we are using the short-hand method of creating threads whick is functionally similar to the function explained earlier. This is specified in the <a href="https://docs.zephyrproject.org/latest/reference/kernel/threads/index.html#spawning-a-thread">docs</a>.</p>
<p>Open up a terminal and fire-up a <em>screen</em> session on the serial device to which the micro:bit is connected to; typically <code>/dev/ttyUSB0</code>. Like so:</p>
<pre><code>&gt; screen /dev/ttyUSB0 115200
</code></pre>
<p>You should see a similar alternating prompt output:</p>
<pre><code>thread1
thread2
thread1
thread2
thread1
thread2
thread1
thread2
</code></pre>
<p>You may note that the board you're using has several uart peripherals (eg. uart1, uart2). The default one that's used is defined in your board's dts file. It's defined as <code>zephyr,console</code>. In our case it's the uart2.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="chapter_3.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="chapter_3.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
