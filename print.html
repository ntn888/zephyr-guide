<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="title-page.html">The Zephyr Guide</a></li><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="chapter_1.html"><strong aria-hidden="true">1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="chapter_2.html"><strong aria-hidden="true">2.</strong> The Kernel API - Threads</a></li><li class="chapter-item expanded "><a href="chapter_3.html"><strong aria-hidden="true">3.</strong> Basic Peripherals API</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="chapter_3-01.html"><strong aria-hidden="true">3.1.</strong> Device Tree 101</a></li><li class="chapter-item expanded "><a href="chapter_3-02.html"><strong aria-hidden="true">3.2.</strong> GPIO</a></li><li class="chapter-item expanded "><a href="chapter_3-03.html"><strong aria-hidden="true">3.3.</strong> Interrupts</a></li><li class="chapter-item expanded "><a href="chapter_3-04.html"><strong aria-hidden="true">3.4.</strong> Timers</a></li><li class="chapter-item expanded "><a href="chapter_3-05.html"><strong aria-hidden="true">3.5.</strong> PWM</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="the-zephyr-guide"><a class="header" href="#the-zephyr-guide">The Zephyr Guide</a></h1>
<p>Hello.</p>
<p>This book will cover all basic aspects of the Zephyr RTOS, to help you get started quickly. Primarily though it will be concerned with the peripheral API, since this is the most I struggled with starting, and is the least well documented in the official docs. A rough overview is as follows:</p>
<ul>
<li>
<p>Environment Setup</p>
</li>
<li>
<p>Kernel API - Primitives</p>
</li>
<li>
<p>Basic Peripherals API</p>
</li>
<li>
<p>Kernel API - Advanced</p>
</li>
<li>
<p>Device Drivers</p>
</li>
</ul>
<p>So buckle up and enjoy the ride...</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Zephyr is currently the preffered RTOS for new embedded product projects. Especially for IoT related projects. Considering that 99% of embedded projects these days is IoT, it is no surprise that Zephyr is the current mainline RTOS taking on the previous mainstay the freeRTOS.</p>
<p>In this text we will go through the basics of Zephyr, enough to get started quickly. Some advanced topics are later covered including a guide porting to a new board.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>The hardware required to follow along is the <a href="https://docs.zephyrproject.org/2.6.0/boards/arm/bbc_microbit_v2/doc/index.html">BBC micro:bit v2</a>*. And obviously a host computer, preferably running a recent edition of Linux. You should have a good grasp of the C language. Previous knowledege in embedded development (MCUs, reading datasheets, protocols, etc) is certainly helpful.</p>
<p>* Currently the book targets the stm32f103c8t6 bluepill. I'll re-adjust to the micro:bit v2.</p>
<h2 id="source-code"><a class="header" href="#source-code">Source Code</a></h2>
<p>The source code for this book is available on the <a href="https://github.com/ntn888/zephyr-guide">Github repository</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>The official docs have a great section on getting the environment setup. (That's about all that's good of the offical docs IMO)
See the <a href="https://docs.zephyrproject.org/latest/getting_started/index.html">Getting Started Guide</a>.</p>
<p>A follow up to this, the <a href="https://docs.zephyrproject.org/latest/application/index.html">Application Development</a> page explaining about how to go about creating a new application folder structure from scratch, is also good.</p>
<p>Once you get this under the belt, you're ready to start building Zephyr applications. This book provides easy hand-holding in the initial phases. So flip over, and let's get started.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="the-kernel-api---threads"><a class="header" href="#the-kernel-api---threads">The Kernel API - Threads</a></h1>
<p>We will now look at the minimum Kernel API required to get going with the Peripherals. We will now look at the Threads API in this section.</p>
<h2 id="thread-creation"><a class="header" href="#thread-creation">Thread Creation</a></h2>
<pre><code>define MY_STACK_SIZE 500
#define MY_PRIORITY 5

extern void my_entry_point(void *, void *, void *);

K_THREAD_STACK_DEFINE(my_stack_area, MY_STACK_SIZE);
struct k_thread my_thread_data;

k_tid_t my_tid = k_thread_create(&amp;my_thread_data, my_stack_area,
                                 K_THREAD_STACK_SIZEOF(my_stack_area),
                                 my_entry_point,
                                 NULL, NULL, NULL,
                                 MY_PRIORITY, 0, K_NO_WAIT);
</code></pre>
<p>The preceding code spawns a thread immediately. We will study the arguments of the above function one at a time.</p>
<p>&amp;my_thread_data:</p>
<p>my_stack_area:</p>
<p>my_entry_point: the entry point function (user defined), that takes upto 3 arguments. It's passed 'NULL' in this example.</p>
<p>MY_PRIORITY: the priority assigned for this thread. We will discuss priorities in detail below.</p>
<p>timeout: the amount of time in milliseconds to wait before the kernel actually starts the thread. Here it's 'K_NO_WAIT'; ie 0.</p>
<h2 id="thread-priorities"><a class="header" href="#thread-priorities">Thread Priorities</a></h2>
<p>&lt; todo &gt;</p>
<h2 id="thread-termination"><a class="header" href="#thread-termination">Thread termination</a></h2>
<p>Once a thread is started it runs forever. A thread may terminate by returning to the caller. ie 'return x'. The thread must be responsible for releasing any held resourses.
To wait until another thread terminates use <code>k_thread_join()</code>.
<code>k_thread_abort()</code> (ungracefully)  terminates the thread. Can be also used from within an external thread. It's not recommended to use this function as it leads to unfreed resources.</p>
<h2 id="notable-system-threads"><a class="header" href="#notable-system-threads">Notable system threads</a></h2>
<p>These are <em>essential threads</em> that are always present in an application.</p>
<h3 id="main-thread"><a class="header" href="#main-thread">main thread</a></h3>
<p>By default has a priority of 0 (highest pre-emptive). Performs kernel initialisation and runs the <code>main()</code> function.</p>
<h3 id="idle-thread"><a class="header" href="#idle-thread">idle thread</a></h3>
<p>Executes when no work. Puts the processor to auto- powersave. Always has the lowest priority.</p>
<h2 id="delays"><a class="header" href="#delays">Delays</a></h2>
<p>&lt; todo &gt;</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="basic-peripherals-api"><a class="header" href="#basic-peripherals-api">Basic Peripherals API</a></h1>
<p>In this section we will see how to operate the GPIO, timers and the PWM.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="device-tree-101"><a class="header" href="#device-tree-101">Device Tree 101</a></h1>
<p>Zephyr uses the device tree, a concept borrowed from Linux. It is a prerequisite to understand this before making any additions to the target board (Zephyr has a predefined set of popular boards, see <a href="https://docs.zephyrproject.org/latest/boards/index.html">here</a>). However we will cover it now before our discussion on peripheral APIs since they build on this and understanding the device tree could ease the process.</p>
<p>But there is already a good video preliminary on <a href="https://www.youtube.com/watch?v=a9CZ1Uk3OYQ&amp;t=6105s">Youtube</a> that'll help you get started. It's quite long (~ 2 hours) and informative. This will help you navigate the device tree specification viewable on <a href="https://www.devicetree.org/">devicetree.org</a> to fill in the gaps.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gpio"><a class="header" href="#gpio">GPIO</a></h1>
<p>We will first discuss the GPIO - the most basic peripheral on an MCU.</p>
<p>As basic functionality of GPIOs, we set the output levels using the following commands:</p>
<pre><code>    gpio_pin_toggle_dt(const struct gpio_dt_spec *spec);
</code></pre>
<pre><code>    gpio_pin_set_dt(const struct gpio_dt_spec *spec, int value);
</code></pre>
<p>Value 0 sets the pin in logical 0 / inactive state. Any value other than 0 sets the pin in logical 1 / active state.</p>
<pre><code>int i = gpio_pin_get_dt(const struct gpio_dt_spec *spec);
</code></pre>
<p>1 – If pin logical value is 1 / active. 0 – If pin logical value is 0 / inactive.</p>
<p>the *_dt functions are a variant for ones without the suffix. For example, gpio_pin_toggle_dt(spec) is:</p>
<pre><code>gpio_pin_toggle(spec-&gt;port, spec-&gt;pin);
</code></pre>
<h2 id="gpio-config"><a class="header" href="#gpio-config">GPIO Config</a></h2>
<p>We must initialse and configure a GPIO pin before we can use it. Use the following command:</p>
<pre><code>gpio_pin_configure_dt(const struct gpio_dt_spec *spec, gpio_flags_t extra_flags);
</code></pre>
<p>Remember to set the correct Pin direction [GPIO_INPUT | GPIO_OUTPUT_INACTIVE | GPIO_OUTPUT_ACTIVE] using the flags.</p>
<h2 id="init-structure"><a class="header" href="#init-structure">Init Structure</a></h2>
<p>Before we could use the above GPIO API, the gpio struct must be defined and assigned:</p>
<pre><code>static const struct gpio_dt_spec myled = GPIO_DT_SPEC_GET(&lt;node_id&gt;, gpios);
</code></pre>
<p>The reference page for <a href="https://docs.zephyrproject.org/latest/reference/peripherals/gpio.html">GPIO</a> details the above functions and also lists other flags that can be used.</p>
<h3 id="example---add-an-external-button"><a class="header" href="#example---add-an-external-button">Example - add an external button</a></h3>
<p>This will require writing an overlay file. And use the GPIO API.</p>
<p>First create the file <code>boards/</code> folder in a new app directory. See <a href="./chapter_1.html#Installation">Installation</a> for creating an empty app template. And in the directory create the file &quot;stm32_min_dev_blue.overlay&quot;, with the following contents. This will be the device tree for the external button addition.</p>
<pre><code>/ {
	gpio_keys {
		compatible = &quot;gpio-keys&quot;;
		butn: butn {
			label = &quot;Key&quot;;
			gpios = &lt;&amp;gpioa 0 GPIO_ACTIVE_LOW&gt;;
		};
	};

	aliases {
		butn0 = &amp;butn;
	};
};
</code></pre>
<p>Wire up a button to the stm32 board with a pull up resistor like this:</p>
<p>&lt; image for connecting button to PA0 &gt;</p>
<p>Using the concepts discussed above; here is the final code for button prompted blink:</p>
<pre><code>#include &lt;zephyr.h&gt;
#include &lt;drivers/gpio.h&gt;
#include &lt;sys/util.h&gt;
#include &lt;inttypes.h&gt;

/* 1000 msec = 1 sec */
#define SLEEP_TIME_MS   1000

/* The devicetree node identifier for the &quot;led0&quot; alias. */
#define LED0_NODE DT_ALIAS(led0)

/*
 * A build error on this line means your board is unsupported.
 * See the sample documentation for information on how to fix this.
 */
static const struct gpio_dt_spec led = GPIO_DT_SPEC_GET(LED0_NODE, gpios);
static const struct gpio_dt_spec specb = GPIO_DT_SPEC_GET(DT_ALIAS(butn0), gpios);

void main(void)
{
	int ret;

	if (!device_is_ready(led.port)) {
		return;
	}
	if (!device_is_ready(specb.port)) {
		return;
	}

	ret = gpio_pin_configure_dt(&amp;led, GPIO_OUTPUT_ACTIVE);
	if (ret &lt; 0) {
		return;
	}
	ret = gpio_pin_configure_dt(&amp;specb, GPIO_INPUT);
	if (ret &lt; 0) {
		return;
	}

	while (1) {
		if (gpio_pin_get(specb.port, specb.pin)) {
			gpio_pin_set(led.port, led.pin, 1);
		}
			
		else {
			gpio_pin_set(led.port, led.pin, 0);
		}
	}
}
</code></pre>
<p>This is a very basic demonstration of push button with no debounce mechanism. The led may inadvertently toggle multiple times for a single push.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="interrupts"><a class="header" href="#interrupts">Interrupts</a></h1>
<p>We will continue on our discussions with the GPIO with looking at interrupts. First for some prerequisites...</p>
<p>&lt; Kernel-&gt; interrupts &gt;</p>
<h2 id="gpio-interrupts"><a class="header" href="#gpio-interrupts">GPIO Interrupts</a></h2>
<pre><code>#include &lt;zephyr.h&gt;
#include &lt;drivers/gpio.h&gt;
#include &lt;sys/util.h&gt;
#include &lt;inttypes.h&gt;

/* 1000 msec = 1 sec */
#define SLEEP_TIME_MS   1000

/* The devicetree node identifier for the &quot;led0&quot; alias. */
#define LED0_NODE DT_ALIAS(led0)

static const struct gpio_dt_spec led = GPIO_DT_SPEC_GET(LED0_NODE, gpios);
static const struct gpio_dt_spec specb = GPIO_DT_SPEC_GET(DT_ALIAS(butn0), gpios);

static struct gpio_callback button_cb_data;

void button_pressed(const struct device *dev, struct gpio_callback *cb,
		    uint32_t pins)
{
	gpio_pin_toggle_dt(&amp;led);
}

void main(void)
{
	int ret;

	if (!device_is_ready(led.port)) {
		return;
	}
	if (!device_is_ready(specb.port)) {
		return;
	}

	ret = gpio_pin_configure_dt(&amp;led, GPIO_OUTPUT_ACTIVE);
	if (ret &lt; 0) {
		return;
	}
	ret = gpio_pin_configure_dt(&amp;specb, GPIO_INPUT);
	if (ret &lt; 0) {
		return;
	}
	ret = gpio_pin_interrupt_configure_dt(&amp;specb,
					      GPIO_INT_EDGE_TO_ACTIVE);
	if (ret != 0) {
		printk(&quot;Error %d: failed to configure interrupt on %s pin %d\n&quot;,
			ret, specb.port-&gt;name, specb.pin);
		return;
	}

	gpio_init_callback(&amp;button_cb_data, button_pressed, BIT(specb.pin));
	gpio_add_callback(specb.port, &amp;button_cb_data);

	while (1) {
	}
}

</code></pre>
<p>The above is a modified example from the samples folder 'basic-&gt;button'. It simply toggles the LED when the button is pushed.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="timers"><a class="header" href="#timers">Timers</a></h1>
<p>Basic timing, there is nothing much to it. We just need a couple of functions for basic timing. If you are familiar with tick based timing in another RTOS, it's exactly the same.</p>
<pre><code>// k_uptime_get_32();        // the original 64bit function is blocking and inefficient, use 32bit if possible

int time_stamp;
int milliseconds_spent;

time_stamp = k_uptime_get_32();

&lt;do stuff&gt;

milliseconds_spent = k_uptime_delta(&amp;time_stamp);

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pwm"><a class="header" href="#pwm">PWM</a></h1>
<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut elit ipsum, bibendum eget semper ac, eleifend sit amet ex. In hac habitasse platea dictumst. Morbi tempus metus a nibh blandit condimentum. Quisque quis neque urna. Etiam eget sapien ac lacus accumsan tincidunt nec nec felis. Quisque placerat, justo vitae congue efficitur, est est volutpat magna, sit amet consectetur purus lorem sed neque. Ut aliquet elit a ultrices hendrerit. In hac habitasse platea dictumst. Pellentesque quis eros lacinia, porttitor justo a, suscipit erat. Etiam vestibulum nibh quis mattis laoreet. Aenean sed lacus in massa elementum dapibus. Maecenas at arcu condimentum, consectetur ipsum a, dignissim nibh. Nulla facilisi. Suspendisse potenti. Aliquam eleifend ultrices gravida. Proin lacinia pellentesque faucibus.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
